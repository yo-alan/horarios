{% extends "admin/base.html" %}

{% block title %}Detalles del espacio {{ espacio }}.{% endblock %}

{% block head %}
    <script>
        $(function (){
            var url = document.location.toString();
            
            if(url.match('#')) {
                $('.nav-tabs a[href=#'+url.split('#')[1]+']').tab('show') ;
            } 
            
            $('.nav-tabs a').on('shown.bs.tab', function (e){
                window.location.hash = e.target.hash;
                window.scrollTo(0, 0);
            });
            
            $("[data-hide]").click(function(){
                $(".alert-danger").attr('class', "alert alert-dismissable alert-danger hidden");
            });
            
            var form = $("#editForm");
            
            form.submit(function (ev){
                
                ev.preventDefault();
                
                $("#" + form.attr('id') + " button[type=submit]").button('loading');
                
                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: form.serialize(),
                    success: function (response){
                        
                        $("#" + form.attr('id') + " button[type=submit]").button('reset');
                        
                        $(".form-group").attr('class', "form-group");
                        
                        if(response.error){
                            
                            if(response.campo){
                                $("#"+ response.campo).parent().attr('class', "form-group has-error");
                                $("#"+ response.campo).focus();
                            }
                            
                            $("#" + form.attr('id') + " .alert").attr('class', "alert alert-dismissable alert-danger");
                            $("#" + form.attr('id') + " .alert p").html(response.error);
                            return;
                        }
                        
                        alert(response.mensaje);
                    }
                });
            });
            
            var formHora = $("#addHoraForm");
            
            formHora.submit(function (ev){
                
                ev.preventDefault();
                
                $("#" + formHora.attr('id') + " button[type=submit]").button('loading');
                
                $.ajax({
                    url: formHora.attr('action'),
                    type: formHora.attr('method'),
                    data: formHora.serialize(),
                    success: function (response){
                        
                        $("#" + formHora.attr('id') + " button[type=submit]").button('reset');
                        
                        $(".form-group").attr('class', "form-group");
                        
                        if(response.error){
                            
                            if(response.campo){
                                $("#"+ response.campo).parent().parent().attr('class', "form-group has-error");
                                $("#"+ response.campo).focus();
                            }
                            
                            $("#" + formHora.attr('id') + " .alert").attr('class', "alert alert-dismissable alert-danger");
                            $("#" + formHora.attr('id') + " .alert p").html(response.error);
                            return;
                        }
                        
                        alert(response.mensaje);
                    }
                });
            });
        });
        
        function onValChange(object){
            object.value = 10 > object.value ? "0" + object.value : object.value;
        }
        
        function agregar(item){
            var texto = item.children[0].innerHTML;
            
            var eAsignadas = document.getElementById('eAsignadas');
            
            item.setAttribute('onclick', 'eliminar(this)');
            
            eAsignadas.appendChild(item);
        }
        
        function eliminar(item){
            var texto = item.children[0].innerHTML;
            
            var eDisponibles = document.getElementById('eDisponibles');
            
            item.setAttribute('onclick', 'agregar(this)');
            
            eDisponibles.appendChild(item);
        }
        
        function agregarProfesional(item){
            var texto = item.children[0].innerHTML;
            
            var pAsignados = document.getElementById('pAsignados');
            
            item.setAttribute('onclick', 'eliminarProfesional(this)');
            
            pAsignados.appendChild(item);
        }
        
        function eliminarProfesional(item){
            var texto = item.children[0].innerHTML;
            
            var pDisponibles = document.getElementById('pDisponibles');
            
            item.setAttribute('onclick', 'agregarProfesional(this)');
            
            pDisponibles.appendChild(item);
        }
        
        function guardarEspecialidades(){
            
            var eAsignadas = document.getElementById('eAsignadas');
            
            var especialidades = []
            
            for(i = 0; i < eAsignadas.children.length; i++){
                especialidades.push(eAsignadas.children[i].id);
            }
            
            $.ajax({
                url: "{% url 'calendario:espacio_add_especialidades' %}",
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    espacio_id: {{ espacio.id }},
                    especialidades: especialidades
                },
                success: function(response) {
                    
                    if(response.error){
                        alert(response.error);
                        return;
                    }
                    
                    alert(response.mensaje);
                }
            });
            
        }
        
        function guardarProfesionales(){
            
            var pAsignados = document.getElementById('pAsignados');
            
            var profesionales = []
            
            for(i = 0; i < pAsignados.children.length; i++){
                profesionales.push(pAsignados.children[i].id);
            }
            
            $.ajax({
                url: "{% url 'calendario:espacio_add_profesionales' %}",
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    espacio_id: {{ espacio.id }},
                    profesionales: profesionales
                },
                success: function(response) {
                    
                    if(response.error){
                        alert(response.error);
                        return;
                    }
                    
                    alert(response.mensaje);
                }
            });
            
        }
        
        function verCalendario(calendario){
            window.location.href = calendario;
        }
        
    </script>
{% endblock %}
{% block article %}
    <h3 class="text-center">
        Detalles del espacio {{ espacio }}.
    </h3>
    <div class="tabbable" id="tabs-776256">
        <ul class="nav nav-tabs">
            <li class="active">
                <a href="#espacio" data-toggle="tab"><i class="glyphicon glyphicon-paperclip"> Espacio</i></a>
            </li>
            <li>
                <a href="#especialidades" data-toggle="tab"><i class="glyphicon glyphicon-th-list"> Especialidades</i></a>
            </li>
            <li>
                {% if espacio.especialidades.all %}
                    <a href="#profesionales" data-toggle="tab"><i class="glyphicon glyphicon-user"> Profesionales</i></a>
                {% else %}
                    <a href="#profesionales"><i class="glyphicon glyphicon-user"> Profesionales</i></a>
                {% endif %}
            </li>
            <li>
                <a href="#horas" data-toggle="tab"><i class="glyphicon glyphicon-time"> Horas</i></a>
            </li>
            <li>
                <a href="#calendarios" data-toggle="tab"><i class="glyphicon glyphicon-calendar"> Calendarios</i></a>
            </li>
        </ul>
        <div class="tab-content">
            <br>
            <div class="tab-pane active" id="espacio">
                <div class="col-xs-6">
                    <table class="table table-bordered overflow">
                        <thead>
                            <tr class="bg-primary">
                                <th>Profesional</th>
                                <th>Especialidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for coordinador in espacio.coordinadores %}
                                <tr class="">
                                    <td class="">
                                        {{ coordinador.profesional }}
                                    </td>
                                    <td class="">
                                        {{ coordinador.especialidad }}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="col-xs-6">
                    <form class="form-inline" id="editForm" method="POST" action="{% url 'calendario:espacio_edit' %}">
                        <div class="alert alert-dismissable alert-danger hidden">
                            <button type="button" class="close" data-hide="alert" aria-hidden="true">
                                ×
                            </button>
                            <h4>
                                Error al guardar el espacio.
                            </h4>
                            <strong>Ojo!</strong> Un campo no es válido:
                            <p>
                            </p>
                        </div>
                        {% csrf_token %}
                        <input id="espacio_id" name="espacio_id" type="hidden" value="{{ espacio.id }}">
                        <div class="form-group">
                            <label class="control-label" for="nombre">Nombre:</label>
                            <input type="text" id="nombre" name="nombre" class="form-control" value="{{ espacio.nombre }}">
                        </div>
                        <button type="submit" id="btnGuardar" data-loading-text="Guardando..." class="btn btn-primary pull-right" autocomplete="off">
                            Guardar
                        </button>
                    </form>
                </div>
            </div>
            <div class="tab-pane" id="especialidades">
                <div class="col-xs-12">
                    <div class="row">
                        <div class="col-xs-5 col-xs-offset-1">
                            <div class="panel panel-primary">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><b>Disponibles</b></h3>
                                </div>
                                <ul id="eDisponibles" class="list-group especialidades overflow">
                                    {% for especialidad in especialidades %}
                                        {% if not especialidad in espacio.especialidades.all %}
                                            <li id="{{ especialidad.id }}" class="btn list-group-item" onclick="agregar(this)">
                                                <p class="text-left">
                                                    {{ especialidad }}
                                                </p>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-xs-5">
                            <div class=" panel panel-primary">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><b>Asignadas</b></h3>
                                </div>
                                <ul id="eAsignadas" class="list-group especialidades overflow">
                                    {% for especialidad in espacio.especialidades.all %}
                                        <li id="{{ especialidad.id }}" class="btn list-group-item" onclick="eliminar(this)">
                                            <p class="text-left">
                                                {{ especialidad }}
                                            </p>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary col-xs-offset-10" onclick="guardarEspecialidades()">
                    Guardar cambios
                </button>
            </div>
            <div class="tab-pane" id="profesionales">
                <div class="alert alert-info" role="alert">
                    <p><span class="glyphicon glyphicon-info-sign"></span> Para asignar un profesional hazle clic. Lo mismo para quitarlo.</p>
                </div>
                <div class="col-xs-12">
                    <div class="row">
                        <div class="col-xs-5 col-xs-offset-1">
                            <div class="panel panel-primary">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><b>Disponibles</b></h3>
                                </div>
                                <ul id="pDisponibles" class="list-group profesionales overflow">
                                    {% for profesional in profesionales %}
                                        {% if not profesional in espacio.profesionales.all %}
                                            <li id="{{ profesional.id }}" class="btn list-group-item" onclick="agregarProfesional(this)">
                                                <p class="text-left">
                                                    {{ profesional }}
                                                </p>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-xs-5">
                            <div class=" panel panel-primary">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><b>Asignados</b></h3>
                                </div>
                                <ul id="pAsignados" class="list-group profesionales overflow">
                                    {% for profesional in espacio.profesionales.all %}
                                        <li id="{{ profesional.id }}" class="btn list-group-item" onclick="eliminarProfesional(this)">
                                            <p class="text-left">
                                                {{ profesional }}
                                            </p>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary col-xs-offset-10" onclick="guardarProfesionales()">
                    Guardar cambios
                </button>
            </div>
            <div class="tab-pane" id="horas">
                <div class="col-xs-10 col-xs-offset-2">
                    {% if error_message %}
                        <div class="alert alert-danger">
                            <a href="#" class="close" data-dismiss="alert">&times;</a>
                            <h3 class="text-center text-danger"><b>Ocurrió el siguiente error:</b></h3>
                            <p class="text-danger">
                                <b>{{ error_message }}</b>
                            </p>
                        </div>
                    {% endif %}
                    <form class="form-horizontal" id="addHoraForm" method="POST" action="{% url 'calendario:espacio_add_hora' %}">
                        {% csrf_token %}
                        <input type="hidden" id="espacio_id" name="espacio_id" value="{{ espacio.id }}">
                        <div class="form-group">
                            <div class="row">
                                <label class="col-xs-3 control-label" for="desde">Hora desde:</label>
                                <div class="col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                    <select id="hora_desde" name="hora_desde" class="form-control">
                                        <option value="00">00</option>
                                        <option value="01">01</option>
                                        <option value="02">02</option>
                                        <option value="03">03</option>
                                        <option value="04">04</option>
                                        <option value="05">05</option>
                                        <option value="06">06</option>
                                        <option value="07">07</option>
                                        <option value="08">08</option>
                                        <option value="09">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                        <option value="16">16</option>
                                        <option value="17">17</option>
                                        <option value="18">18</option>
                                        <option value="19">19</option>
                                        <option value="20">20</option>
                                        <option value="21">21</option>
                                        <option value="22">22</option>
                                        <option value="23">23</option>
                                    </select>
                                </div>
                                <div class="col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                    <select id="min_desde" name="min_desde" class="form-control">
                                        <option value="00">00</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="30">30</option>
                                        <option value="40">40</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <label class="col-xs-3 control-label" for="hasta">Hora hasta:</label>
                                <div class="col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                    <select id="hora_hasta" name="hora_hasta" class="form-control">
                                        <option value="01">01</option>
                                        <option value="02">02</option>
                                        <option value="03">03</option>
                                        <option value="04">04</option>
                                        <option value="05">05</option>
                                        <option value="06">06</option>
                                        <option value="07">07</option>
                                        <option value="08">08</option>
                                        <option value="09">09</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                        <option value="16">16</option>
                                        <option value="17">17</option>
                                        <option value="18">18</option>
                                        <option value="19">19</option>
                                        <option value="20">20</option>
                                        <option value="21">21</option>
                                        <option value="22">22</option>
                                        <option value="23">23</option>
                                    </select>
                                </div>
                                <div class="col-xs-3 col-sm-3 col-md-2 col-lg-2">
                                    <select id="min_hasta" name="min_hasta" class="form-control">
                                        <option value="00">00</option>
                                        <option value="10">10</option>
                                        <option value="20">20</option>
                                        <option value="30">30</option>
                                        <option value="40">40</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-xs-offset-10">
                                <button type="submit" id="btnHoraGuardar" data-loading-text="Guardando..." class="btn btn-primary pull-right" autocomplete="off">
                                    Agregar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-pane" id="calendarios">
                <div class="col-xs-5">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title"><b>{{ espacio.calendarios|length }} calendarios en total.</b></h3>
                        </div>
                        <ul id="ulCalendarios" class="list-group calendarios overflow">
                            {% for calendario in espacio.calendarios %}
                                <li id="{{ calendario.id }}" class="btn list-group-item" onclick="verCalendario('{% url 'calendario:detail' calendario.id %}')">
                                    <p class="text-left">
                                        {{ calendario.id }}
                                    </p>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <!--
                    Mini-calendario.
                -->
                <table class="table mini-calendario">
                    <thead>
                        <tr class="bg-primary">
                            <th class="text-center">
                            </th>
                            {% for dia in dias %}
                                <th class="text-center">
                                    <h4><strong>{{ dia }}</strong></h4>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for hora in espacio.horas %}
                            <tr>
                                <td class="text-center bg-primary">
                                    <h4>
                                        <strong>{{ hora.hora_desde }}</strong>
                                    </h4>
                                </td>
                                {% for dia in espacio.dias_habiles %}
                                    <td class="text-center active">
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <form class="form-horizontal" id="" method="POST" action="{% url 'calendario:generar' %}">
                    {% csrf_token %}
                    <input type="hidden" id="espacio_id" name="espacio_id" value="{{ espacio.id }}">
                    {% if listo %}
                        <button type="submit" class="btn btn-success pull-right"  data-loading-text="Generando..." onclick="$(this).button('loading')">
                    {% else %}
                        <button type="submit" class="btn btn-success pull-right" disabled  data-loading-text="Generando..." onclick="$(this).button('loading')">
                    {% endif %}
                        Generar
                    </button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block alert %}
    <div class="alert alert-info" role="alert">
        <p>
            <span class="glyphicon glyphicon-info-sign"></span>
            <strong>Nota:</strong> Para asignar una especialidad
            disponible clickeala. Haz lo mismo para quitarla.
        </p>
    </div>
{% endblock %}
